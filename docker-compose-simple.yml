services:
  # Angular Dashboard Integration - SIMPLE /dashboard/en/ setup
  angular_dashboard:
    container_name: angular_dashboard
    image: ghcr.io/prabaljainn/orochi-ui:sha-ead43a1
    restart: always
    environment:
      # NO BOX mode - just simple /dashboard/en/ structure
      BOX: 'false'
      # Connect to CVAT API through internal network
      CVAT_API_URL: "http://cvat_server:8080/api"
      CVAT_HOST: "${CVAT_HOST:-localhost}"
    labels:
      traefik.enable: "true"
      traefik.http.services.angular-dashboard.loadbalancer.server.port: "80"
      # ---- Middlewares ----

      # (Optional) CORS (camelCase keys)
      traefik.http.middlewares.dashboard-cors.headers.accessControlAllowMethods: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
      traefik.http.middlewares.dashboard-cors.headers.accessControlAllowHeaders: "Content-Type,Authorization,X-CSRFToken,X-Requested-With,Cookie"
      traefik.http.middlewares.dashboard-cors.headers.accessControlAllowCredentials: "true"
      traefik.http.middlewares.dashboard-cors.headers.accessControlMaxAge: "86400"
      traefik.http.middlewares.dashboard-cors.headers.accessControlAllowOriginList: "https://${CVAT_HOST:-localhost}"

      # Security headers
      traefik.http.middlewares.dashboard-security.headers.contentSecurityPolicy: "upgrade-insecure-requests; default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self' https: wss:; font-src 'self' https:; object-src 'none'; media-src 'self' https:; frame-src 'self' https:;"
      traefik.http.middlewares.dashboard-security.headers.stsSeconds: "31536000"
      traefik.http.middlewares.dashboard-security.headers.stsIncludeSubdomains: "true"
      traefik.http.middlewares.dashboard-security.headers.stsPreload: "true"
      traefik.http.middlewares.dashboard-security.headers.forceSTSHeader: "true"
      traefik.http.middlewares.dashboard-security.headers.referrerPolicy: "strict-origin-when-cross-origin"
      traefik.http.middlewares.dashboard-security.headers.customRequestHeaders.X-Forwarded-Proto: "https"
      traefik.http.middlewares.dashboard-security.headers.customRequestHeaders.X-Forwarded-Port: "443"
      traefik.http.middlewares.dashboard-security.headers.customRequestHeaders.X-Forwarded-Ssl: "on"

      # SIMPLE routing - just /dashboard/ paths (NO PREFIX)
      # HTTP to HTTPS redirect
      traefik.http.routers.angular-dashboard-http.rule: Host(`${CVAT_HOST:-localhost}`) && (PathPrefix(`/dashboard`) || (PathPrefix(`/en`) && !PathPrefix(`/api/`)) || (PathPrefix(`/ja`) && !PathPrefix(`/api/`)) || (PathPrefix(`/hi`) && !PathPrefix(`/api/`)) || (PathPrefix(`/ar`) && !PathPrefix(`/api/`)) || (PathPrefix(`/es`) && !PathPrefix(`/api/`)) || (PathPrefix(`/te`) && !PathPrefix(`/api/`)))
      traefik.http.routers.angular-dashboard-http.entrypoints: web
      traefik.http.routers.angular-dashboard-http.middlewares: "dashboard-https-redirect"
      traefik.http.routers.angular-dashboard-http.priority: "2000"

      # HTTPS redirect middleware
      traefik.http.middlewares.dashboard-https-redirect.redirectscheme.scheme: "https"
      traefik.http.middlewares.dashboard-https-redirect.redirectscheme.permanent: "true"

      # HTTPS routes - just /dashboard/ paths (NO PREFIX)
      traefik.http.routers.angular-dashboard-https.rule: Host(`${CVAT_HOST:-localhost}`) && (PathPrefix(`/dashboard`) || (PathPrefix(`/en`) && !PathPrefix(`/api/`)) || (PathPrefix(`/ja`) && !PathPrefix(`/api/`)) || (PathPrefix(`/hi`) && !PathPrefix(`/api/`)) || (PathPrefix(`/ar`) && !PathPrefix(`/api/`)) || (PathPrefix(`/es`) && !PathPrefix(`/api/`)) || (PathPrefix(`/te`) && !PathPrefix(`/api/`)))
      traefik.http.routers.angular-dashboard-https.entrypoints: websecure
      traefik.http.routers.angular-dashboard-https.tls: "true"
      traefik.http.routers.angular-dashboard-https.tls.certresolver: lets-encrypt
      traefik.http.routers.angular-dashboard-https.middlewares: "dashboard-cors,dashboard-security"
      traefik.http.routers.angular-dashboard-https.priority: "2000"

    # DON'T mount custom nginx - let container handle it automatically
    networks:
      - cvat
    depends_on:
      - cvat_server
    # Add resource limits
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  cvat_server:
    # ... your cvat_server config ...
